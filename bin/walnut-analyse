#!/usr/bin/env php
<?php
require __DIR__ . '/inc/autoload.php';
require __DIR__ . '/inc/error-display.php';

use Walnut\Lang\Blueprint\AST\Node\SourceLocation;
use Walnut\Lang\Blueprint\Compilation\CompilationException;
use Walnut\Lang\Implementation\Compilation\AST\NodeAstCodeMapper;
use Walnut\Lang\Implementation\Compilation\CompilationErrorBuilder;
use Walnut\Lang\Implementation\Compilation\CompilerFactory;
use Walnut\Lang\Implementation\Compilation\Module\PackageConfiguration\JsonFilePackageConfigurationProvider;
use Walnut\Lib\Walex\SourcePosition;

// Parse arguments
$showErrorsOnly = false;
$folder = '.';

for ($i = 1; $i < count($argv); $i++) {
    if ($argv[$i] === '--show-errors-only') {
        $showErrorsOnly = true;
    } elseif (!str_starts_with($argv[$i], '--')) {
        $folder = $argv[$i];
    }
}

/** @var string $sourceRoot */
$cfg = new JsonFilePackageConfigurationProvider('nutcfg.json');
$packageConfig = $cfg->packageConfiguration;

$sourceRoot = $packageConfig->defaultRoot;
$root = $sourceRoot . '/';
if (!file_exists($root . $folder)) {
    echo "Folder $folder does not exist in $sourceRoot" . PHP_EOL;
    exit(1);
}

// Create compiler with code mapper
$codeMapper = new NodeAstCodeMapper();
$compiler = (new CompilerFactory())->defaultCompiler($packageConfig, $codeMapper);
$errorBuilder = new CompilationErrorBuilder($codeMapper);

$errorCount = 0;
$fileCount = 0;

foreach (new RecursiveIteratorIterator(new RecursiveDirectoryIterator($root . $folder)) as $file) {
    $pathname = $file->getPathname();
    if (str_ends_with($pathname, '.nut') && !str_ends_with($pathname, '.test.nut')) {
        $fileCount++;
        $source = substr($pathname, strlen($root), -4);
        if (!$showErrorsOnly) {
            echo PHP_EOL, "Analysing ", $source, PHP_EOL;
        }

        $compilationResult = $compiler->safeCompile($source);

        if ($compilationResult->errorState instanceof CompilationException) {
            $errors = $errorBuilder->build($compilationResult->errorState);

            if (count($errors) > 0) {
                $errorCount++;
                if ($showErrorsOnly) {
                    echo PHP_EOL, "Analysing ", $source, PHP_EOL;
                }

                displayErrorsWithPointers(
                    $errors,
                    $sourceRoot,
                    $source
                );
            }
        } else {
            if (!$showErrorsOnly) {
                echo "\033[0;32mâœ“ OK\033[0m", PHP_EOL;
            }
        }
    }
}

echo PHP_EOL, "Analysis complete: $fileCount file(s) checked, $errorCount error(s)" . PHP_EOL;
exit($errorCount > 0 ? 1 : 0);
