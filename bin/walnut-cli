#!/usr/bin/env php
<?php
require __DIR__ . '/inc/autoload.php';
require __DIR__ . '/inc/error-display.php';

use Walnut\Lang\Blueprint\Compilation\CompilationException;
use Walnut\Lang\Blueprint\Program\InvalidEntryPointDependency;
use Walnut\Lang\Implementation\Compilation\AST\NodeAstCodeMapper;
use Walnut\Lang\Implementation\Compilation\CompilationErrorBuilder;
use Walnut\Lang\Implementation\Compilation\CompilerFactory;
use Walnut\Lang\Implementation\Compilation\Module\PackageConfiguration\JsonFilePackageConfigurationProvider;
use Walnut\Lang\Implementation\Compilation\Module\SourceFinder\CallbackSourceFinder;
use Walnut\Lang\Implementation\Compilation\Module\SourceFinder\CompositeSourceFinder;
use Walnut\Lang\Implementation\Compilation\Module\SourceFinder\PackageBasedSourceFinder;
use Walnut\Lang\Implementation\Program\EntryPoint\Cli\CliEntryPoint;
use Walnut\Lang\Implementation\Program\EntryPoint\Cli\CliEntryPointBuilder;

$input = $argv;
array_shift($input);
$source = array_shift($input);

if (!isset($source)) {
    echo "Usage: walnut-cli <source> [<args>]\n";
    exit(1);
}

// Get package configuration
$packageConfig = (new JsonFilePackageConfigurationProvider('nutcfg.json'))->packageConfiguration;
$sourceRoot = $packageConfig->defaultRoot;

// Read stdin once if source is '$' or 'stdin' (avoids reading stdin multiple times during compilation)
// This is needed because php://stdin can only be read once
$stdinContent = null;
if ($source === '$' || $source === 'stdin') {
    $stdinContent = file_get_contents('php://stdin');
}

// Create compiler with code mapper for error display
$codeMapper = new NodeAstCodeMapper();
$compiler = new CompilerFactory()->customCompiler(
    new CompositeSourceFinder(
        new CallbackSourceFinder([
            'stdin.nut' => fn() => $stdinContent ?? file_get_contents('php://stdin')
        ]),
        new PackageBasedSourceFinder(
            new JsonFilePackageConfigurationProvider('nutcfg.json')
        )
    ),
    $codeMapper
);
$errorBuilder = new CompilationErrorBuilder($codeMapper);

// Try to compile the source
$compilationResult = $compiler->safeCompile($source);

if ($compilationResult->errorState instanceof CompilationException) {
    displayErrorsWithPointers(
        $errorBuilder->build($compilationResult->errorState),
        $sourceRoot,
        $source
    );
    exit(1);
}

try {
    $ep = new CliEntryPoint(new CliEntryPointBuilder($compiler));
    $content = $ep->call($source, ... $input);
    echo $content, PHP_EOL;
} catch (InvalidEntryPointDependency $d) {
    echo "\033[0;31mâœ— ERROR\033[0m", PHP_EOL;
    echo "\033[0;34m", $d->getMessage(), "\033[0m", PHP_EOL, PHP_EOL;
    exit(1);
}